<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DCF Lab – Manual & API (3 vues)</title>
<style>
  /* ===== Base / Theme ===== */
  *,*::before,*::after{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);overflow-x:hidden}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.4;-webkit-font-smoothing:antialiased}
  :root{
    --navy:#0b2545; --navy-2:#0f335f;
    --bg:#f6f7fb; --card:#fff; --text:#1b1f23; --muted:#6b7280; --border:#e8e9ef; --row-alt:#fafbfe;
    --shadow:0 10px 28px rgba(6,24,44,.12); --radius:16px; --container: 1100px;
  }
  [data-theme="dark"]{ --bg:#0e131a; --card:#131a22; --text:#e6e9ef; --muted:#9aa3b2; --border:#1f2a37; --row-alt:#0d1117; --shadow:0 10px 28px rgba(0,0,0,.35) }

  .wrap{max-width:var(--container);margin:0 auto;padding:1rem}
  h1{margin:1rem 0 .25rem;text-align:center;color:var(--navy);font-weight:900}
  .sub{color:var(--muted);text-align:center;margin-bottom:1rem}

  /* Tabs */
  .tabs{display:flex;gap:.6rem;justify-content:center;flex-wrap:wrap;margin:.5rem auto 1rem}
  .tab{border:1px solid var(--border);background:var(--card);border-radius:999px;padding:.55rem 1rem;font-weight:800;cursor:pointer;transition:.15s transform}
  .tab:hover{transform:translateY(-1px)}
  .tab.active{background:var(--navy);color:#fff;border-color:var(--navy)}

  /* Cards & Layouts */
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem;animation:fadeIn .25s ease}
  .card h2{margin:.1rem 0 .7rem;color:var(--navy);font-size:1.2rem}
  .page{display:none}
  .page.active{display:block}
  .grid-2{display:grid;grid-template-columns: 1fr 1fr;gap:1rem}
  .grid-2.rev{grid-template-columns: 1fr 1fr}
  /* Left/Right columns min-width 0 to avoid overflow */
  .grid-2 > *{min-width:0}

  /* Forms & Controls */
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:.7rem}
  .field{display:flex;flex-direction:column;gap:.35rem}
  label{font-size:.85rem;color:var(--muted)}
  input[type="text"],input[type="number"],input[type="date"],select{
    width:100%;min-width:0;padding:.58rem .7rem;border:1px solid var(--border);border-radius:10px;background:#fff;outline:none
  }
  [data-theme="dark"] input,[data-theme="dark"] select{background:#0f1720;color:#e6edf5;border-color:#263244}
  input:focus,select:focus{box-shadow:0 0 0 3px rgba(11,37,69,.15)}
  input[type="range"]{width:100%}

  .actions{display:flex;gap:.6rem;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--navy);background:var(--navy);color:#fff;border-radius:10px;padding:.6rem .95rem;font-weight:800;cursor:pointer}
  .btn:hover{background:var(--navy-2)}
  .btn-ghost{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--border);background:#fff;color:var(--navy);border-radius:10px;padding:.6rem .95rem;font-weight:800}
  [data-theme="dark"] .btn-ghost{background:#0f1720;color:#e6edf5}

  .btn-outline{display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--border);border-radius:999px;padding:.5rem .9rem;background:transparent;color:var(--navy);text-decoration:none}
  .footer{margin-top:1rem;text-align:center}

  /* KPIs */
  .kpis{display:grid;grid-template-columns:1fr;gap:.7rem}
  .kpi{border:1px solid var(--border);border-radius:12px;padding:.7rem;background:#fff;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:.25rem;min-height:86px;justify-content:center}
  [data-theme="dark"] .kpi{background:#0f1720}
  .kpi .lbl{font-size:.8rem;color:var(--muted)}
  .kpi .val{font-size:1.2rem;font-weight:900;color:var(--navy)}
  [data-theme="dark"] .kpi .val{color:#e6edf5}

  /* Tables */
  .table-wrap{overflow:auto;border-radius:12px;-webkit-overflow-scrolling:touch}
  table{width:100%;border-collapse:collapse;font-size:.95rem;margin-top:.6rem;min-width:560px}
  th,td{padding:.7rem;border:1px solid #e4e6ee;text-align:left}
  th{background:var(--navy);color:#fff;position:sticky;top:0;z-index:1}
  [data-theme="dark"] th{background:#18263a}
  tbody tr:nth-child(even){background:var(--row-alt)}
  tbody tr:hover{background:#eef3ff}
  [data-theme="dark"] tbody tr:hover{background:#172033}

  .tag{display:inline-flex;align-items:center;gap:.35rem;background:#fff;border:1px solid var(--border);border-radius:999px;padding:.25rem .6rem;color:#333;font-size:.85rem}
  [data-theme="dark"] .tag{background:#0f1720;color:#e2e6ee}
  .sec-link{text-decoration:none;display:inline-flex;align-items:center;gap:.4rem;background:#fff7ea;border:1px solid #f0e1bf;padding:.35rem .6rem;border-radius:999px;color:#7a5b14;font-weight:800}

  .chart-wrap{border:1px dashed var(--border);border-radius:12px;padding:.7rem}
  canvas{width:100%;height:260px;display:block}

  @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

  /* Responsive */
  @media (max-width: 1024px){
    .grid-2, .grid-2.rev{grid-template-columns:1fr}
  }
</style>
</head>
<body data-theme="light">
  <header class="wrap" role="banner">
    <h1>DCF Lab</h1>
    <p class="sub">Manual &amp; API views — one at a time.</p>
    <div class="tabs" id="tabs" role="tablist" aria-label="Page switcher">
      <button class="tab active" data-target="p-manual" aria-selected="true">Manual DCF</button>
      <button class="tab" data-target="p-api" aria-selected="false">API DCF</button>
      <button class="tab" data-target="p-docs" aria-selected="false">Docs / Notes</button>
    </div>
  </header>

  <main class="wrap">
    <!-- ===== PAGE 1: MANUAL (KPIs LEFT, CONTENT RIGHT) ===== -->
    <section id="p-manual" class="page active" aria-labelledby="tab-manual">
      <div class="grid-2 rev">
        <!-- LEFT: KPIs -->
        <aside>
          <div class="kpis" aria-label="Manual DCF KPIs">
            <div class="kpi"><div class="lbl">Σ PV(UFCF)</div><div class="val" id="mPVUFCF">—</div></div>
            <div class="kpi"><div class="lbl">PV(Terminal)</div><div class="val" id="mPVTerm">—</div></div>
            <div class="kpi"><div class="lbl">Enterprise Value</div><div class="val" id="mEV">—</div></div>
            <div class="kpi"><div class="lbl">Equity / Share</div><div class="val" id="mEPS">—</div></div>
          </div>

          <div class="card" style="margin-top:1rem">
            <h2>Sensitivity (WACC × g)</h2>
            <div id="mSens" class="kpis"></div>
          </div>

          <div class="card" style="margin-top:1rem">
            <h2>Tornado (1-var sensitivities)</h2>
            <div class="chart-wrap"><canvas id="mTornado"></canvas></div>
          </div>

          <div class="footer">
            <a href="../index.html" class="btn-outline">← Go Back</a>
          </div>
        </aside>

        <!-- RIGHT: FORM + CHART + TABLE -->
        <div class="card">
          <h2>Manual DCF (Unlevered)</h2>

          <div class="row" style="margin-bottom:.7rem;">
            <div class="field" style="grid-column: span 6;">
              <label for="mSym">Ticker (for labeling)</label>
              <input type="text" id="mSym" value="DEMO" placeholder="e.g., AAPL" autocomplete="off" />
            </div>

            <div class="field" style="grid-column: span 6;">
              <label for="mShares">Shares Outstanding (diluted)</label>
              <input type="number" id="mShares" value="15000000000" step="1000000" />
            </div>

            <div class="field" style="grid-column: span 6;">
              <label for="mNetDebt">Net Debt (Debt – Cash)</label>
              <input type="number" id="mNetDebt" value="80000000000" step="1000000" />
            </div>

            <div class="field actions" style="grid-column: span 6; align-self:end;">
              <button class="btn" id="mReset" type="button">Reset</button>
              <button class="btn-ghost" id="mSave" type="button">Save Scenario</button>
              <button class="btn-ghost" id="mLoad" type="button">Load Scenario</button>
            </div>

            <div class="field" style="grid-column: span 6;">
              <label for="mWacc">WACC (%)</label>
              <input type="range" id="mWacc" min="4" max="16" step="0.1" value="9.0" />
              <div><span class="tag">Current WACC: <b id="mWaccV">9.0%</b></span></div>
            </div>

            <div class="field" style="grid-column: span 6;">
              <label for="mTVMethod">Terminal Method</label>
              <select id="mTVMethod">
                <option value="gordon">Gordon Growth (perpetuity)</option>
                <option value="multiple">Exit Multiple (EBITDA or FCF)</option>
              </select>
            </div>

            <div class="field" style="grid-column: span 6;">
              <label for="mG">LT Growth g (%) (Gordon)</label>
              <input type="range" id="mG" min="0" max="6" step="0.1" value="3.0"/>
              <div><span class="tag">g: <b id="mGV">3.0%</b></span></div>
            </div>

            <div class="field" style="grid-column: span 3;">
              <label for="mMultiple">Exit Multiple (if Multiple)</label>
              <input type="number" id="mMultiple" value="12" step="0.5"/>
            </div>

            <div class="field" style="grid-column: span 3;">
              <label for="mExitBase">Exit Base (value in final year)</label>
              <select id="mExitBase">
                <option value="fcf">FCF</option>
                <option value="ebitda">EBITDA</option>
              </select>
            </div>
          </div>

          <div class="chart-wrap"><canvas id="mChart"></canvas></div>

          <div class="table-wrap" style="margin-top:.7rem">
            <table aria-label="Manual DCF free cash flow table">
              <thead>
                <tr><th>Year</th><th>UFCF</th><th>EBITDA (opt.)</th><th>Notes</th></tr>
              </thead>
              <tbody id="mRows"></tbody>
            </table>
          </div>

          <div class="actions" style="margin-top:.7rem;">
            <button class="btn-ghost" id="mAddYear" type="button">+ Add Year</button>
            <button class="btn-ghost" id="mDelYear" type="button">– Remove Last</button>
            <button class="btn" id="mExport" type="button">Export CSV</button>
            <button class="btn" id="mPrint" type="button">Print / PDF</button>
            <button class="btn-ghost" id="mCopyURL" type="button">Copy Shareable URL</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== PAGE 2: API (METRICS LEFT, KPIs RIGHT) ===== -->
    <section id="p-api" class="page" aria-labelledby="tab-api">
      <div class="grid-2">
        <!-- LEFT: Metrics table -->
        <aside class="card">
          <h2>Custom DCF Snapshot (API)</h2>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Metric</th><th>Value</th><th>Source</th></tr></thead>
              <tbody id="aCustomTbl">
                <tr><td colspan="3" style="text-align:center;color:#666">Click Load…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="footer">
            <a href="../index.html" class="btn-outline">← Go Back</a>
          </div>
        </aside>

        <!-- RIGHT: Controls + KPIs + Levered -->
        <div>
          <div class="card">
            <h2>API DCF (Custom vs. Levered)</h2>
            <div class="row" style="margin-bottom:.7rem;">
              <div class="field" style="grid-column: span 6;">
                <label for="aSym">Ticker</label>
                <input type="text" id="aSym" value="AAPL" autocomplete="off" />
              </div>
              <div class="field" style="grid-column: span 6;">
                <label for="aPrice">Market price (info)</label>
                <input type="text" id="aPrice" disabled/>
              </div>
              <div class="field" style="grid-column: span 6;">
                <label for="aRF">Risk-free (info)</label>
                <input type="text" id="aRF" disabled/>
              </div>
              <div class="field actions" style="grid-column: span 6; align-self:end;">
                <button class="btn" id="aLoad" type="button">Load</button>
                <button class="btn-ghost" id="aReset" type="button">Reset</button>
              </div>

              <div class="field" style="grid-column: span 6;">
                <label for="aWacc">WACC (%)</label>
                <input type="range" id="aWacc" min="4" max="16" step="0.1" value="9.1"/>
                <div><span class="tag">WACC: <b id="aWaccV">9.1%</b></span></div>
              </div>
              <div class="field" style="grid-column: span 6;">
                <label for="aG">Terminal Growth g (%)</label>
                <input type="range" id="aG" min="0" max="6" step="0.1" value="4.0"/>
                <div><span class="tag">g: <b id="aGV">4.0%</b></span></div>
              </div>

              <div class="field" style="grid-column: span 6;">
                <label for="aAuto">Auto-refresh (60s)</label>
                <label class="switch">
                  <input id="aAuto" type="checkbox" role="switch" aria-checked="false">
                  <span class="slider" aria-hidden="true"></span>
                </label>
              </div>
              <div class="field actions" style="grid-column: span 6; align-self:end;">
                <button class="btn" id="aExport" type="button">Export CSV</button>
                <button class="btn-ghost" id="aCopyURL" type="button">Copy Shareable URL</button>
              </div>
            </div>
          </div>

          <div class="kpis" style="margin-top:1rem">
            <div class="kpi"><div class="lbl">Σ PV(UFCF) (API)</div><div class="val" id="aPVU">—</div></div>
            <div class="kpi"><div class="lbl">PV(Terminal) (recalc)</div><div class="val" id="aPVT">—</div></div>
            <div class="kpi"><div class="lbl">EV (recalc)</div><div class="val" id="aEV">—</div></div>
            <div class="kpi"><div class="lbl">Equity / Share (recalc)</div><div class="val" id="aEQPS">—</div></div>
          </div>

          <div class="card" style="margin-top:1rem">
            <h2>Levered DCF (API)</h2>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Item</th><th>Value</th><th>Note</th></tr></thead>
                <tbody id="aLeveredTbl">
                  <tr><td colspan="3" style="text-align:center;color:#666">Waiting…</td></tr>
                </tbody>
              </table>
            </div>

            <div style="margin-top:.7rem">
              <span class="tag">SEC/URLs styled as tags</span>
              <span id="aSec"></span>
            </div>
          </div>

          <div class="kpis" style="margin-top:1rem">
            <div class="kpi"><div class="lbl">Levered DCF / Share (API)</div><div class="val" id="aLevPS">—</div></div>
            <div class="kpi"><div class="lbl">Price vs. Custom DCF</div><div class="val" id="aGapC">—</div></div>
            <div class="kpi"><div class="lbl">Price vs. Levered DCF</div><div class="val" id="aGapL">—</div></div>
            <div class="kpi"><div class="lbl">WACC / g (active)</div><div class="val"><span id="aWmini">—</span>% / <span id="aGmini">—</span>%</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== PAGE 3: DOCS (CENTER) ===== -->
    <section id="p-docs" class="page" aria-labelledby="tab-docs">
      <div class="card" style="max-width:820px;margin:0 auto">
        <h2>Docs &amp; Notes</h2>
        <p><b>Manual DCF</b> lets you control everything (UFCF, WACC, growth rate, exit multiple).
          <b>API DCF</b> loads a snapshot from FinancialModelingPrep and lets you stress-test WACC and g on the client side.</p>
        <ul>
          <li><b>Shortcuts</b>: R = reset (active tab), S = save (Manual), L = load (Manual), T = toggle theme</li>
          <li><b>Exports</b>: Export CSV (UFCF / KPI table), Print for PDF</li>
          <li><b>Share</b>: “Copy Shareable URL” encode tes inputs dans l’URL</li>
        </ul>
        <div class="kpis">
          <div class="kpi"><div class="lbl">Unlevered DCF → EV → Equity = EV – Net Debt</div></div>
          <div class="kpi"><div class="lbl">Levered DCF rend directement une valeur par action post-dette</div></div>
          <div class="kpi"><div class="lbl">Levered DCF directly provides an equity value per share after debt</div></div>
        </div>

        <div class="footer">
          <a href="../index.html" class="btn-outline">← Go Back</a>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* ===== Utilities ===== */
    const $ = (id)=>document.getElementById(id);
    const fmt = (n,d=2)=>(n==null||isNaN(n))?"—":Number(n).toLocaleString(undefined,{maximumFractionDigits:d,minimumFractionDigits:d});
    const pct = (n,d=1)=>(n==null||isNaN(n))?"—":`${fmt(n,d)}%`;
    const money = (n,d=0)=>(n==null||isNaN(n))?"—":`$${Number(n).toLocaleString(undefined,{maximumFractionDigits:d})}`;
    const num = (x)=>{ const v=Number(x); return isNaN(v)?null:v; };
    const toCSV = (rows)=>rows.map(r=>r.map(v=>{const s=(v==null)?"":String(v);return s.includes(",")?`"${s.replace(/"/g,'""')}"`:s;}).join(",")).join("\n");
    function download(name, content, type="text/csv"){ const blob=new Blob([content],{type}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},100); }

    /* ===== Tabs show-one-at-a-time ===== */
    const pages = ["p-manual","p-api","p-docs"];
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const target = btn.dataset.target;
        document.querySelectorAll(".tab").forEach(b=>b.classList.toggle("active", b===btn));
        pages.forEach(id=>{ const el=$(id); el.classList.toggle("active", id===target); });
      });
    });

    /* ===== Charts (HiDPI) ===== */
    function drawLineChart(canvas, labels, values){
      const ctx = canvas.getContext("2d");
      const ratio = Math.max(1, Math.min(window.devicePixelRatio||1, 3));
      const cssW = canvas.clientWidth || 300, cssH = 260;
      canvas.width = Math.floor(cssW*ratio); canvas.height = Math.floor(cssH*ratio); ctx.scale(ratio,ratio);
      const w=cssW,h=cssH, pad=40;
      const min=Math.min(...values), max=Math.max(...values);
      const yMin=Math.min(0,min), yMax=Math.max(0,max), xstep=(w-pad*2)/((values.length-1)||1);
      ctx.clearRect(0,0,w,h);
      ctx.strokeStyle="#cbd5e1"; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,h-pad); ctx.stroke();
      ctx.strokeStyle="#3b82f6"; ctx.lineWidth=2; ctx.beginPath();
      values.forEach((v,i)=>{ const x=pad+i*xstep; const y=h-pad-(v-yMin)/(yMax-yMin||1)*(h-pad*2); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);});
      ctx.stroke();
      ctx.fillStyle="#0ea5e9";
      values.forEach((v,i)=>{ const x=pad+i*xstep; const y=h-pad-(v-yMin)/(yMax-yMin||1)*(h-pad*2); ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); });
    }
    function drawTornado(canvas, baseValue, items){
      const ctx = canvas.getContext("2d");
      const ratio = Math.max(1, Math.min(window.devicePixelRatio||1, 3));
      const cssW = canvas.clientWidth || 300, cssH = 260;
      canvas.width=Math.floor(cssW*ratio); canvas.height=Math.floor(cssH*ratio); ctx.scale(ratio,ratio);
      const w=cssW,h=cssH,pad=10,midX=w/2,barH=(h-pad*2)/items.length*.6,gap=(h-pad*2)/items.length;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle="#94a3b8"; ctx.textBaseline="middle"; ctx.font="12px sans-serif";
      items.forEach((it,idx)=>{ const cy=pad+idx*gap+gap/2;
        const leftW=Math.max(0,-it.low/100)*(w*.4); ctx.fillStyle="#ef4444"; ctx.fillRect(midX-leftW,cy-barH/2,leftW,barH);
        const rightW=Math.max(0,it.high/100)*(w*.4); ctx.fillStyle="#10b981"; ctx.fillRect(midX,cy-barH/2,rightW,barH);
        ctx.fillStyle="#94a3b8"; ctx.fillText(it.label,8,cy);
      });
      ctx.strokeStyle="#cbd5e1"; ctx.beginPath(); ctx.moveTo(midX,pad); ctx.lineTo(midX,h-pad); ctx.stroke();
    }

    /* ===== Manual State & Logic ===== */
    const mState = {
      baseYear: new Date().getFullYear(),
      rows: [],
      wacc: 9.0, g: 3.0, method: "gordon", multiple: 12, exitBase: "fcf",
      shares: 15000000000, netDebt: 80000000000, symbol: "DEMO"
    };
    function mInitRows(n=5){
      mState.rows = [];
      for(let i=1;i<=n;i++){
        mState.rows.push({ year: mState.baseYear+i, fcf: 1e10*(1+0.05*i), ebitda: 1.5e10*(1+0.04*i), note:"" });
      }
    }
    mInitRows();

    const mRows = $("mRows");
    function mRenderRows(){
      mRows.innerHTML = mState.rows.map((r,idx)=>`
        <tr>
          <td><input type="number" data-idx="${idx}" data-k="year" value="${r.year}"/></td>
          <td><input type="number" data-idx="${idx}" data-k="fcf" value="${r.fcf}" step="1000000"/></td>
          <td><input type="number" data-idx="${idx}" data-k="ebitda" value="${r.ebitda}" step="1000000"/></td>
          <td><input type="text" data-idx="${idx}" data-k="note" value="${r.note}" placeholder="assumption…"/></td>
        </tr>`).join("");
    }
    mRenderRows();

    function debounce(fn,wait=60){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }
    mRows.addEventListener("input", debounce((e)=>{
      const t=e.target; if(!t) return; const i=+t.dataset.idx; const k=t.dataset.k;
      const v=(k==="note")?t.value:num(t.value); if(mState.rows[i]){ mState.rows[i][k]=v; mRecalc(); }
    }, 10));

    ["mWacc","mG","mTVMethod","mMultiple","mExitBase","mShares","mNetDebt","mSym"].forEach(id=>{
      const el=$(id); if(!el) return;
      const handler = (e)=>{
        if(id==="mWacc"){ mState.wacc=+e.target.value; $("mWaccV").textContent=`${mState.wacc.toFixed(1)}%`; }
        else if(id==="mG"){ mState.g=+e.target.value; $("mGV").textContent=`${mState.g.toFixed(1)}%`; }
        else if(id==="mTVMethod"){ mState.method=e.target.value; }
        else if(id==="mMultiple"){ mState.multiple=+e.target.value; }
        else if(id==="mExitBase"){ mState.exitBase=e.target.value; }
        else if(id==="mShares"){ mState.shares=num(e.target.value); }
        else if(id==="mNetDebt"){ mState.netDebt=num(e.target.value); }
        else if(id==="mSym"){ mState.symbol=e.target.value; return; }
        mRecalc();
      };
      el.addEventListener(el.type==="text"?"input":"change", handler);
      if(id==="mWacc"||id==="mG") el.addEventListener("input", handler);
    });

    function mRecalc(){
      const w=Math.max(0.0001,mState.wacc/100), g=Math.max(0,mState.g/100);
      const f=mState.rows.map(r=>num(r.fcf)||0), years=mState.rows.map(r=>r.year);
      let pvU=0; f.forEach((fcf,i)=>{ pvU+= fcf/Math.pow(1+w,i+1); });
      let tv=0;
      if(mState.method==="gordon"){
        const fT1=f[f.length-1]*(1+g); if(w>g) tv=fT1/(w-g);
      }else{
        const baseVal=(mState.exitBase==="fcf"? f[f.length-1] : (num(mState.rows.at(-1).ebitda)||0));
        tv=baseVal*mState.multiple;
      }
      const pvT= tv/Math.pow(1+w,f.length);
      const EV=pvU+pvT, Eq=EV-(mState.netDebt||0), EqPS=Eq/(mState.shares||1);
      $("mPVUFCF").textContent=money(pvU,0);
      $("mPVTerm").textContent=money(pvT,0);
      $("mEV").textContent=money(EV,0);
      $("mEPS").textContent=isFinite(EqPS)?`$${fmt(EqPS,2)}`:"—";

      drawLineChart($("mChart"), years, f);

      // Sensitivity grid (as KPI cards)
      const waccs=[w-0.02,w-0.01,w,w+0.01,w+0.02].map(x=>Math.max(0.03,x));
      const gs=[g-0.01,g,g+0.01,g+0.02].map(x=>Math.max(0,x));
      const sens = [];
      gs.forEach(gg=>{
        waccs.forEach(ww=>{
          const pvU2=f.reduce((a,c,i)=>a + c/Math.pow(1+ww,i+1),0);
          const tv2=(mState.method==="gordon"&&ww>gg)?(f.at(-1)*(1+gg)/(ww-gg)):tv;
          const pvT2= tv2/Math.pow(1+ww,f.length);
          const EV2=pvU2+pvT2, Eq2=EV2-(mState.netDebt||0), ps=Eq2/(mState.shares||1);
          sens.push({ww,gg,ps});
        });
      });
      const mSens=$("mSens"); mSens.innerHTML="";
      sens.forEach(s=>{
        const div=document.createElement("div"); div.className="kpi";
        div.innerHTML=`<div class="lbl">WACC ${pct(s.ww*100)} / g ${pct(s.gg*100)}</div><div class="val">$${fmt(s.ps,2)}</div>`;
        mSens.appendChild(div);
      });

      // Tornado
      const basePS=EqPS;
      const wUp=(()=>{const ww=w+0.005; const pvU2=f.reduce((a,c,i)=>a+c/Math.pow(1+ww,i+1),0);
        const tv2=(mState.method==="gordon"&&ww>g)?f.at(-1)*(1+g)/(ww-g):tv;
        return ((pvU2+ tv2/Math.pow(1+ww,f.length))-(mState.netDebt||0))/(mState.shares||1);})();
      const wDn=(()=>{const ww=w-0.005; const pvU2=f.reduce((a,c,i)=>a+c/Math.pow(1+ww,i+1),0);
        const tv2=(mState.method==="gordon"&&ww>g)?f.at(-1)*(1+g)/(ww-g):tv;
        return ((pvU2+ tv2/Math.pow(1+ww,f.length))-(mState.netDebt||0))/(mState.shares||1);})();
      const gUp=(()=>{const gg=g+0.005; const tv2=(mState.method==="gordon"&&w>gg)?f.at(-1)*(1+gg)/(w-gg):tv;
        return ((pvU + tv2/Math.pow(1+w,f.length))-(mState.netDebt||0))/(mState.shares||1);})();
      const gDn=(()=>{const gg=g-0.005; const tv2=(mState.method==="gordon"&&w>gg)?f.at(-1)*(1+gg)/(w-gg):tv;
        return ((pvU + tv2/Math.pow(1+w,f.length))-(mState.netDebt||0))/(mState.shares||1);})();
      const tbUp=(()=>{const b=(mState.exitBase==="fcf"? f.at(-1)*1.1 : (mState.rows.at(-1).ebitda||0)*1.1);
        const tv2=(mState.method==="multiple")? b*mState.multiple : tv;
        return ((pvU + tv2/Math.pow(1+w,f.length))-(mState.netDebt||0))/(mState.shares||1);})();
      const tbDn=(()=>{const b=(mState.exitBase==="fcf"? f.at(-1)*0.9 : (mState.rows.at(-1).ebitda||0)*0.9);
        const tv2=(mState.method==="multiple")? b*mState.multiple : tv;
        return ((pvU + tv2/Math.pow(1+w,f.length))-(mState.netDebt||0))/(mState.shares||1);})();

      const items=[
        {label:"WACC ±50 bps", low:(wUp-basePS)/basePS*100, high:(wDn-basePS)/basePS*100},
        {label:"g ±50 bps",    low:(gDn-basePS)/basePS*100, high:(gUp-basePS)/basePS*100},
        {label:"Exit base ±10%",low:(tbDn-basePS)/basePS*100, high:(tbUp-basePS)/basePS*100},
      ];
      drawTornado($("mTornado"), basePS, items);
    }
    mRecalc();

    // Manual actions
    $("mAddYear").addEventListener("click", ()=>{ const last=mState.rows.at(-1); const ny=(last?.year||mState.baseYear)+1;
      mState.rows.push({ year:ny, fcf:last?last.fcf*1.05:1e10, ebitda:last?last.ebitda*1.04:1.5e10, note:"" }); mRenderRows(); mRecalc();
    });
    $("mDelYear").addEventListener("click", ()=>{ if(mState.rows.length>1){ mState.rows.pop(); mRenderRows(); mRecalc(); }});
    $("mExport").addEventListener("click", ()=>{ const rows=[["Year","UFCF","EBITDA","Note"]]; mState.rows.forEach(r=>rows.push([r.year,r.fcf,r.ebitda,r.note||""]));
      rows.push([]); rows.push(["WACC",mState.wacc+"%"],["g",mState.g+"%"],["Method",mState.method],["Multiple",mState.multiple],["ExitBase",mState.exitBase],["NetDebt",mState.netDebt],["Shares",mState.shares]);
      download(`ManualDCF_${mState.symbol}.csv`, toCSV(rows)); });
    $("mPrint").addEventListener("click", ()=>window.print());
    $("mSave").addEventListener("click", ()=>{ const key=prompt("Scenario name to save?", `${mState.symbol}_manual`); if(!key) return;
      try{ localStorage.setItem(`dcf_manual_${key}`, JSON.stringify(mState)); alert("Saved."); }catch(e){ alert("Save failed (localStorage)."); }});
    $("mLoad").addEventListener("click", ()=>{ const keys=Object.keys(localStorage).filter(k=>k.startsWith("dcf_manual_")); if(!keys.length){ alert("No scenarios saved."); return; }
      const key=prompt(`Available:\n${keys.join("\n")}\n\nEnter exact key:`); if(!key) return;
      const raw=localStorage.getItem(key); if(!raw) return; const obj=JSON.parse(raw); Object.assign(mState,obj);
      $("mWacc").value=mState.wacc; $("mWaccV").textContent=`${mState.wacc.toFixed(1)}%`; $("mG").value=mState.g; $("mGV").textContent=`${mState.g.toFixed(1)}%`;
      $("mTVMethod").value=mState.method; $("mMultiple").value=mState.multiple; $("mExitBase").value=mState.exitBase; $("mShares").value=mState.shares; $("mNetDebt").value=mState.netDebt; $("mSym").value=mState.symbol;
      mRenderRows(); mRecalc();
    });
    $("mCopyURL").addEventListener("click", ()=>{
      const usp=new URLSearchParams({
        view:"manual", sym:mState.symbol, wacc:mState.wacc, g:mState.g, method:mState.method, mult:mState.multiple, exit:mState.exitBase,
        shares:mState.shares, netDebt:mState.netDebt,
        rows: encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(mState.rows)))))
      });
      history.replaceState(null,"",`?${usp.toString()}`);
      navigator.clipboard.writeText(location.href).then(()=>alert("URL copied!"));
    });
    $("mReset").addEventListener("click", ()=>{
      $("mSym").value="DEMO"; mState.symbol="DEMO"; $("mShares").value=1.5e10; mState.shares=1.5e10; $("mNetDebt").value=8e10; mState.netDebt=8e10;
      $("mWacc").value=9.0; $("mWaccV").textContent="9.0%"; mState.wacc=9.0; $("mG").value=3.0; $("mGV").textContent="3.0%"; mState.g=3.0;
      $("mTVMethod").value="gordon"; mState.method="gordon"; $("mMultiple").value=12; mState.multiple=12; $("mExitBase").value="fcf"; mState.exitBase="fcf";
      mInitRows(); mRenderRows(); mRecalc();
    });

    /* ===== API DCF ===== */
    const API_KEY="YwfOXlKh6wObb2vPLEsCqQfxmOzXKdan";
    const ENDPOINT_CUSTOM =(sym)=>`https://financialmodelingprep.com/stable/custom-discounted-cash-flow?symbol=${encodeURIComponent(sym)}&apikey=${API_KEY}`;
    const ENDPOINT_LEVERED=(sym)=>`https://financialmodelingprep.com/stable/levered-discounted-cash-flow?symbol=${encodeURIComponent(sym)}&apikey=${API_KEY}`;

    const aState={ sym:"AAPL", price:null, rf:null, sumPvUfcf:null, terminalValue:null, presentTerminalValue:null, discountFactorTerminal:null,
      netDebt:null, shares:null, wacc:9.1, g:4.0, leveredPS:null, secLink:null, fcfT1:null, auto:false, timer:null };

    function aSetSlidersFromState(){ $("aWacc").value=aState.wacc; $("aWaccV").textContent=`${aState.wacc.toFixed(1)}%`; $("aG").value=aState.g; $("aGV").textContent=`${aState.g.toFixed(1)}%`; $("aWmini").textContent=aState.wacc.toFixed(1); $("aGmini").textContent=aState.g.toFixed(1); }
    function aFillCustomTable(c){
      const tb=$("aCustomTbl");
      const rows=[
        ["WACC (API)",pct(c.wacc),"Custom DCF"],["LT Growth g (API)",pct(c.longTermGrowthRate),"Custom DCF"],["Beta",fmt(c.beta,3),"Custom DCF"],
        ["Cost of Equity",pct(c.costOfEquity),"Custom DCF"],["Cost of Debt",pct(c.costofDebt),"Custom DCF"],["Tax Rate",pct(c.taxRate),"Custom DCF"],
        ["UFCF (t+1)",money(c.freeCashFlowT1,0),"Custom DCF"],["Σ PV(UFCF)",money(c.sumPvUfcf,0),"Custom DCF"],
        ["Terminal Value",money(c.terminalValue,0),"Custom DCF"],["PV(Terminal)",money(c.presentTerminalValue,0),"Custom DCF"],
        ["Enterprise Value",money(c.enterpriseValue,0),"Custom DCF"],["Net Debt",money(c.netDebt,0),"Custom DCF"],["Diluted Shares",fmt(c.dilutedSharesOutstanding,0),"Custom DCF"],
        ["Equity / Share",`$${fmt(c.equityValuePerShare,2)}`,"Custom DCF"],["Market Price",`$${fmt(c.price,2)}`,"Custom DCF"],["Risk-free Rate",pct(c.riskFreeRate),"Custom DCF"],["MRP",pct(c.marketRiskPremium),"Custom DCF"],
      ];
      tb.innerHTML=rows.map(([k,v,s])=>`<tr><td>${k}</td><td>${v}</td><td>${s}</td></tr>`).join("");
    }
    function aFillLeveredTable(l){
      const tb=$("aLeveredTbl");
      const rows=[["Levered DCF / Share",`$${fmt(l.dcf,2)}`,"Levered DCF API"],["As-of Date",l.date||"—","Levered DCF API"]];
      tb.innerHTML=rows.map(([k,v,s])=>`<tr><td>${k}</td><td>${v}</td><td>${s}</td></tr>`).join("");
    }
    function aSetKPI(){
      $("aPVU").textContent=money(aState.sumPvUfcf,0);
      $("aPVT").textContent=money(aState.presentTerminalValue,0);
      const EV=(aState.sumPvUfcf||0)+(aState.presentTerminalValue||0);
      $("aEV").textContent=money(EV,0);
      const EqPS=(aState.shares&&aState.netDebt!=null)?((EV-aState.netDebt)/aState.shares):null;
      $("aEQPS").textContent=isFinite(EqPS)?`$${fmt(EqPS,2)}`:"—";
      if(aState.price!=null){
        const gapC=(EqPS!=null&&isFinite(EqPS)&&aState.price>0)?((EqPS-aState.price)/aState.price*100):null;
        $("aGapC").textContent=(gapC==null||isNaN(gapC))?"—":`${gapC>=0?"+":""}${fmt(gapC,1)}%`;
        const gapL=(aState.leveredPS!=null&&aState.price>0)?((aState.leveredPS-aState.price)/aState.price*100):null;
        $("aGapL").textContent=(gapL==null||isNaN(gapL))?"—":`${gapL>=0?"+":""}${fmt(gapL,1)}%`;
      }
      $("aWmini").textContent=aState.wacc.toFixed(1); $("aGmini").textContent=aState.g.toFixed(1);
    }
    function aRecompute(){
      const w=aState.wacc/100, g=aState.g/100;
      if(aState.fcfT1==null||aState.discountFactorTerminal==null){ aSetKPI(); return; }
      if(w>g){ const newTV=aState.fcfT1*(1+g)/(w-g); const newPVTV=newTV*aState.discountFactorTerminal; aState.presentTerminalValue=newPVTV; }
      aSetKPI();
    }
    $("aWacc").addEventListener("input", e=>{ aState.wacc=+e.target.value; $("aWaccV").textContent=`${aState.wacc.toFixed(1)}%`; aRecompute(); });
    $("aG").addEventListener("input", e=>{ aState.g=+e.target.value; $("aGV").textContent=`${aState.g.toFixed(1)}%`; aRecompute(); });

    async function aLoad(sym){
      $("aCustomTbl").innerHTML=`<tr><td colspan="3" style="text-align:center;color:#666">Loading…</td></tr>`;
      $("aLeveredTbl").innerHTML=`<tr><td colspan="3" style="text-align:center;color:#666">Loading…</td></tr>`;
      ["aPVU","aPVT","aEV","aEQPS","aLevPS","aGapC","aGapL"].forEach(id=>$(id).textContent="—"); $("aSec").innerHTML="";
      try{
        const [rC,rL]=await Promise.all([fetch(ENDPOINT_CUSTOM(sym)), fetch(ENDPOINT_LEVERED(sym))]);
        if(!rC.ok||!rL.ok) throw new Error(`HTTP ${rC.status}/${rL.status}`);
        const arrC=await rC.json(), arrL=await rL.json();
        const c=Array.isArray(arrC)&&arrC.length?arrC[0]:null, l=Array.isArray(arrL)&&arrL.length?arrL[0]:null;
        if(!c){ $("aCustomTbl").innerHTML=`<tr><td colspan="3" style="text-align:center;color:#b00">No Custom DCF for ${sym}</td></tr>`; return; }
        aFillCustomTable(c);

        aState.sym=sym;
        aState.sumPvUfcf=num(c.sumPvUfcf);
        aState.terminalValue=num(c.terminalValue);
        aState.presentTerminalValue=num(c.presentTerminalValue);
        aState.discountFactorTerminal=(aState.terminalValue&&aState.presentTerminalValue)?(aState.presentTerminalValue/aState.terminalValue):null;
        aState.netDebt=num(c.netDebt);
        aState.shares=num(c.dilutedSharesOutstanding);
        aState.price=num(c.price);
        aState.rf=num(c.riskFreeRate);
        aState.fcfT1=num(c.freeCashFlowT1);
        aState.secLink=c.link||null;

        if(num(c.wacc)!=null) aState.wacc=num(c.wacc);
        if(num(c.longTermGrowthRate)!=null) aState.g=num(c.longTermGrowthRate);
        aSetSlidersFromState();

        $("aPrice").value=aState.price!=null?`$${fmt(aState.price,2)}`:"—";
        $("aRF").value=aState.rf!=null?`${fmt(aState.rf,2)} %`:"—";

        if(l){ aState.leveredPS=num(l.dcf); $("aLevPS").textContent=`$${fmt(aState.leveredPS,2)}`; aFillLeveredTable(l); }
        else { $("aLeveredTbl").innerHTML=`<tr><td colspan="3" style="text-align:center;color:#b00">No Levered DCF for ${sym}</td></tr>`; }

        if(aState.secLink){ $("aSec").innerHTML=`&nbsp;<a class="sec-link" href="${aState.secLink}" target="_blank" rel="noopener">🔗 SEC Filing</a>`; }
        aRecompute();
      }catch(e){
        console.error(e);
        $("aCustomTbl").innerHTML=`<tr><td colspan="3" style="text-align:center;color:#b00">Error loading data</td></tr>`;
        $("aLeveredTbl").innerHTML=`<tr><td colspan="3" style="text-align:center;color:#b00">Error loading data</td></tr>`;
      }
    }
    $("aLoad").addEventListener("click", ()=>{ const s=($("aSym").value||"").trim().toUpperCase(); if(s) aLoad(s); });
    $("aReset").addEventListener("click", ()=>{ $("aSym").value="AAPL"; aLoad("AAPL"); });
    $("aAuto").addEventListener("change", (e)=>{ aState.auto=e.target.checked; if(aState.timer){clearInterval(aState.timer);aState.timer=null;}
      if(aState.auto){ aState.timer=setInterval(()=>{ const s=($("aSym").value||"").trim().toUpperCase(); if(s) aLoad(s); }, 60000); }});
    $("aExport").addEventListener("click", ()=>{
      const rows=[["Symbol",aState.sym],["Price",aState.price],["RF",aState.rf],["WACC(active)",aState.wacc],["g(active)",aState.g],["Σ PV(UFCF)",aState.sumPvUfcf],["PV(Terminal)",aState.presentTerminalValue],["Net Debt",aState.netDebt],["Shares",aState.shares]];
      download(`API_DCF_${aState.sym}.csv`, toCSV(rows));
    });
    $("aCopyURL").addEventListener("click", ()=>{
      const usp=new URLSearchParams({view:"api", sym: $("aSym").value, wacc:$("aWacc").value, g:$("aG").value});
      history.replaceState(null,"",`?${usp.toString()}`); navigator.clipboard.writeText(location.href).then(()=>alert("URL copied!"));
    });

    // Load initial data
    aLoad("AAPL");

    /* ===== Routing via URL ?view= ===== */
    (function initialViewFromURL(){
      const q=new URLSearchParams(location.search); const v=q.get("view");
      if(!v) return;
      const map={manual:"p-manual",api:"p-api",docs:"p-docs"};
      const id=map[v]; if(!id) return;
      document.querySelectorAll(".tab").forEach(b=>b.classList.toggle("active", b.dataset.target===id));
      pages.forEach(pid=>$(pid).classList.toggle("active", pid===id));
    })();

    /* Repaint charts on resize */
    window.addEventListener("resize", debounce(()=>{ mRecalc(); aRecompute(); },150));
  </script>
</body>
</html>
