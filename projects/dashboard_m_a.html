<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>M&A Transactions – Advisors & Analytics</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable"></script>
<style>
:root{--brand:#003366;--brand-2:#0a4a82;--bg:#f5f7fa;--text:#16181d;--muted:#6b7280;--card:#ffffff;--border:#e5e7eb;--row-alt:#f9fafb;--shadow:0 6px 18px rgba(0,0,0,.10);--radius:14px}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
h1{margin:0 0 .5rem 0;text-align:center;color:var(--brand);font-weight:800;letter-spacing:.2px}
.sub{color:var(--muted);text-align:center;margin-bottom:1rem}
.wrapper{max-width:1200px;margin:0 auto;padding:0 1rem}
.tabs{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap;margin:0 auto 1rem auto}
.tab{background:var(--card);border:1px solid var(--border);padding:.55rem 1rem;border-radius:999px;cursor:pointer;box-shadow:var(--shadow);transition:.2s transform,.2s background;font-weight:700;user-select:none}
.tab:hover{transform:translateY(-1px)}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.kpis{display:grid;grid-template-columns:repeat(12,1fr);gap:.8rem;margin:1rem auto}
.kpi{grid-column:span 3;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1rem;box-shadow:var(--shadow)}
.kpi h3{margin:0 0 .25rem 0;font-size:.95rem;color:var(--muted);font-weight:600}
.kpi .val{font-size:1.6rem;font-weight:800}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:.8rem}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:1rem}
.filters{display:grid;grid-template-columns:repeat(12,1fr);gap:.6rem;align-items:end;margin-bottom:.8rem}
.field{display:flex;flex-direction:column;gap:.35rem}
label{font-size:.85rem;color:var(--muted)}
input[type="date"],input[type="text"],select{padding:.55rem .7rem;border:1px solid var(--border);border-radius:10px;background:#fff;outline:none}
select[multiple]{height:2.6rem}
.btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:.6rem .95rem;cursor:pointer;font-weight:700}
.btn:hover{background:var(--brand-2)}
.btn-ghost{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--border);background:#fff;color:var(--brand);border-radius:10px;padding:.6rem .95rem;cursor:pointer;font-weight:700}
.btn-ghost:hover{background:#eef5ff}
.pills{display:flex;flex-wrap:wrap;gap:.4rem}
.pill{border:1px solid var(--border);background:#fff;border-radius:999px;padding:.35rem .75rem;cursor:pointer;font-weight:700}
.pill.active{background:var(--brand);border-color:var(--brand);color:#fff}
.toolbar{display:flex;flex-wrap:wrap;gap:.6rem;justify-content:space-between;align-items:center;margin:.8rem 0 1.2rem 0}
.muted{color:var(--muted);font-size:.9rem}
.table-wrap{max-height:60vh;overflow:auto;border-radius:12px}
table{width:100%;border-collapse:collapse;font-size:.95rem}
th,td{padding:.7rem;border:1px solid #ddd;text-align:left}
th{background:var(--brand);color:#fff;position:sticky;top:0;z-index:1;cursor:pointer;user-select:none}
tr:nth-child(even){background:var(--row-alt)}
tbody tr{transition:background .2s}
tbody tr:hover{background:#e8f0fe}
.sec-link{display:inline-flex;align-items:center;gap:.4rem;text-decoration:none;background:#f1f6ff;border:1px solid #cfe3ff;padding:.35rem .6rem;border-radius:999px;color:#0a3d73;font-weight:700}
.sec-link:hover{background:#e7f0ff}
.chip{font-size:.82rem;border-radius:999px;padding:.2rem .55rem;border:1px solid var(--border);background:#fff;color:#333;margin-right:.25rem;display:inline-block}
.footer{display:flex;flex-direction:column;align-items:center;gap:.6rem;margin:1.2rem auto 2rem auto;text-align:center;color:var(--muted)}
@media (max-width:900px){.filters{grid-template-columns:1fr 1fr}.kpi{grid-column:span 6}}
</style>
</head>
<body>
<div class="wrapper">
  <h1>M&A Transactions – Advisors & Analytics</h1>
  <div class="sub">Daily-enriched public data. Advisors inferred from filings and press releases when available.</div>

  <div class="tabs">
    <div class="tab active" data-tab="latest">Latest</div>
    <div class="tab" data-tab="byacquirer">By Acquirer</div>
  </div>

  <div class="kpis">
    <div class="kpi"><h3>Deals YTD</h3><div class="val" id="kpiYTD">0</div></div>
    <div class="kpi"><h3>Deals Last 30 Days</h3><div class="val" id="kpi30">0</div></div>
    <div class="kpi"><h3>With GS/MS/JPM</h3><div class="val" id="kpiTopBanks">0</div></div>
    <div class="kpi"><h3>Last Update</h3><div class="val" id="kpiUpdate">--:--</div></div>
  </div>

  <div class="grid">
    <div class="card" style="grid-column:span 12;">
      <div class="filters">
        <div class="field" style="grid-column:span 2;">
          <label>Start date</label>
          <input type="date" id="startDate"/>
        </div>
        <div class="field" style="grid-column:span 2;">
          <label>End date</label>
          <input type="date" id="endDate"/>
        </div>
        <div class="field" style="grid-column:span 4;">
          <label>Search (Acquirer / Target / Ticker)</label>
          <input type="text" id="searchInput" placeholder="Type to filter…"/>
        </div>
        <div class="field byacq-only" style="grid-column:span 2;display:none;">
          <label>Acquirer</label>
          <select id="acquirerSelect"><option value="">All</option></select>
        </div>
        <div class="field" style="grid-column:span 2;">
          <label>Advisors</label>
          <select id="advisorSelect" multiple>
            <option>Goldman Sachs</option>
            <option>Morgan Stanley</option>
            <option>J.P. Morgan</option>
            <option>Bank of America</option>
            <option>Barclays</option>
            <option>Citi</option>
          </select>
        </div>
      </div>
      <div class="toolbar">
        <div class="pills">
          <div class="pill" data-range="7">Last 7 days</div>
          <div class="pill" data-range="30">Last 30 days</div>
          <div class="pill" data-range="90">Last 90 days</div>
          <div class="pill" data-range="all">All</div>
        </div>
        <div style="display:flex;gap:.6rem;align-items:center;">
          <button class="btn-ghost" id="exportPdf">Export PDF</button>
          <button class="btn" id="applyFilters">Apply Filters</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="ma-table">
          <thead>
            <tr>
              <th data-sort="date">Date ▲▼</th>
              <th data-sort="acquirer">Acquirer</th>
              <th data-sort="tickerA">Acq. Ticker</th>
              <th data-sort="target">Target</th>
              <th data-sort="tickerT">Tgt. Ticker</th>
              <th>Advisors</th>
              <th>Sources</th>
              <th>SEC</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="8" style="text-align:center;">Loading…</td></tr></tbody>
        </table>
      </div>
      <div class="toolbar">
        <div class="muted">Showing <span id="shownCount">0</span> of <span id="totalCount">0</span></div>
        <div class="muted" id="activeView">View: Latest</div>
      </div>
    </div>

    <div class="card" style="grid-column:span 6;">
      <h3 style="margin:0 0 .6rem 0;color:var(--brand);font-weight:800;">Top Advisors YTD</h3>
      <canvas id="chartAdvisors" height="220"></canvas>
    </div>
    <div class="card" style="grid-column:span 6;">
      <h3 style="margin:0 0 .6rem 0;color:var(--brand);font-weight:800;">Deals by Month</h3>
      <canvas id="chartMonths" height="220"></canvas>
    </div>
  </div>

  <div class="footer">
    <div>This demo uses public sources and heuristic parsing. Advisors coverage may be partial, especially for non-US deals.</div>
  </div>
</div>

<script>
const ROWS_PER_PAGE = 15
const DATA_URL = (location.hostname.endsWith(".github.io") ? (location.origin + location.pathname.replace(/\/[^/]*$/,"") + "/portfolio/data/ma_enriched.json") : "./data/ma_enriched.json")
let RAW=[], VIEW=[], TAB="latest", SORT={key:"date",dir:"desc"}, PAGE=1
const tbody=document.querySelector("#ma-table tbody")
const shownCount=document.getElementById("shownCount")
const totalCount=document.getElementById("totalCount")
const tabs=document.querySelectorAll(".tab")
const activeView=document.getElementById("activeView")
const startDate=document.getElementById("startDate")
const endDate=document.getElementById("endDate")
const searchInput=document.getElementById("searchInput")
const applyBtn=document.getElementById("applyFilters")
const acqWrap=document.querySelector(".byacq-only")
const acqSelect=document.getElementById("acquirerSelect")
const advSelect=document.getElementById("advisorSelect")
const kpiYTD=document.getElementById("kpiYTD")
const kpi30=document.getElementById("kpi30")
const kpiTopBanks=document.getElementById("kpiTopBanks")
const kpiUpdate=document.getElementById("kpiUpdate")
const pills=document.querySelectorAll(".pill")
let chartAdvisors, chartMonths

function parseDate(d){if(!d)return null;const iso=d.length>10?d.replace(" ","T"):d;const x=new Date(iso);return isNaN(+x)?null:x}
function fmtDate(d){if(!d)return "";const y=d.getFullYear();const m=("0"+(d.getMonth()+1)).slice(-2);const dd=("0"+d.getDate()).slice(-2);return `${y}-${m}-${dd}`}
function getItemDate(it){return it.date||""}
function updateSortIndicators(){const labels={date:"Date",acquirer:"Acquirer",tickerA:"Acq. Ticker",target:"Target",tickerT:"Tgt. Ticker"};document.querySelectorAll("th[data-sort]").forEach(th=>{const k=th.dataset.sort;const is=(SORT.key===k);const arrow=is?(SORT.dir==='asc'?' ▲':' ▼'):' ▲▼';th.textContent=labels[k]+arrow})}
function baseForTab(tab,list){if(tab==="byacquirer"){const sel=acqSelect.value||"";return sel?list.filter(it=>(it.acquirer||"")===sel):list}return list}
function filterByAdvisors(list){const chosen=Array.from(advSelect.selectedOptions).map(o=>o.value);if(!chosen.length)return list;return list.filter(it=>Array.isArray(it.advisors)&&it.advisors.some(a=>chosen.includes(a)))}
function applyFiltersAndSort(){
  const search=(searchInput.value||"").toLowerCase()
  const sd=startDate.value?new Date(startDate.value):null
  const ed=endDate.value?new Date(endDate.value):null
  let list=baseForTab(TAB, RAW)
  if(search){list=list.filter(it=>{const a=(it.acquirer||"").toLowerCase();const t=(it.target||"").toLowerCase();const sa=(it.acquirerTicker||"").toLowerCase();const st=(it.targetTicker||"").toLowerCase();return a.includes(search)||t.includes(search)||sa.includes(search)||st.includes(search)})}
  if(sd||ed){list=list.filter(it=>{const d=parseDate(getItemDate(it));if(!d)return false;if(sd&&d<sd)return false;if(ed){const ed2=new Date(ed);ed2.setHours(23,59,59,999);if(d>ed2)return false}return true})}
  list=filterByAdvisors(list)
  const k=SORT.key, dir=SORT.dir
  list.sort((a,b)=>{
    let va,vb
    if(k==="date"){va=parseDate(getItemDate(a));vb=parseDate(getItemDate(b));const res=(!va&&!vb)?0:(!va?1:!vb?-1:(va-vb));return dir==="asc"?res:-res}
    else if(k==="acquirer"){va=(a.acquirer||"");vb=(b.acquirer||"")}
    else if(k==="target"){va=(a.target||"");vb=(b.target||"")}
    else if(k==="tickerA"){va=(a.acquirerTicker||"");vb=(b.acquirerTicker||"")}
    else if(k==="tickerT"){va=(a.targetTicker||"");vb=(b.targetTicker||"")}
    else {va="";vb=""}
    return dir==="asc"?va.localeCompare(vb):vb.localeCompare(va)
  })
  VIEW=list
}
function buildAcquirerSelect(){const uniq=[...new Set(RAW.map(it=>it.acquirer).filter(Boolean))].sort();acqSelect.innerHTML=`<option value="">All</option>`+uniq.map(n=>`<option value="${n}">${n}</option>`).join("")}
function render(){
  const total=VIEW.length
  totalCount.textContent=RAW.length
  shownCount.textContent=total
  const pages=Math.max(1, Math.ceil(total/ROWS_PER_PAGE))
  if(PAGE>pages)PAGE=pages
  const start=(PAGE-1)*ROWS_PER_PAGE
  const slice=VIEW.slice(start, start+ROWS_PER_PAGE)
  if(!slice.length){tbody.innerHTML=`<tr><td colspan="8" style="text-align:center;color:#666;">No data for the current view/filters</td></tr>`}
  else{
    tbody.innerHTML=slice.map(it=>{
      const adv=(it.advisors||[]).map(a=>`<span class="chip">${a}</span>`).join(" ")
      const src=(it.advisor_sources||[]).slice(0,2).map(u=>`<a class="sec-link" href="${u}" target="_blank" rel="noopener">🔗</a>`).join(" ")
      const sec=it.secLink?`<a class="sec-link" href="${it.secLink}" target="_blank" rel="noopener">🔗</a>`:`<span class="chip">N/A</span>`
      return `<tr>
        <td>${getItemDate(it)||""}</td>
        <td>${it.acquirer||""}</td>
        <td>${it.acquirerTicker||""}</td>
        <td>${it.target||""}</td>
        <td>${it.targetTicker||""}</td>
        <td>${adv||'<span class="chip">N/A</span>'}</td>
        <td>${src||'<span class="chip">N/A</span>'}</td>
        <td>${sec}</td>
      </tr>`
    }).join("")
  }
  updateSortIndicators()
  updateKPIs()
  updateCharts()
}
function setRange(days){
  pills.forEach(p=>p.classList.remove("active"))
  if(days==="all"){startDate.value="";endDate.value=""}
  else{
    const ed=new Date();const sd=new Date();sd.setDate(sd.getDate()-Number(days))
    startDate.value=fmtDate(sd);endDate.value=fmtDate(ed)
  }
  PAGE=1;update()
  pills.forEach(p=>{if(p.dataset.range===String(days))p.classList.add("active")})
}
function update(){
  applyFiltersAndSort()
  render()
}
tabs.forEach(t=>{t.addEventListener("click",()=>{tabs.forEach(x=>x.classList.remove("active"));t.classList.add("active");TAB=t.dataset.tab;activeView.textContent=`View: ${t.textContent}`;const show=TAB==="byacquirer";acqWrap.style.display=show?"":"none";PAGE=1;update()})})
document.querySelectorAll("th[data-sort]").forEach(th=>{th.addEventListener("click",()=>{const key=th.dataset.sort;if(SORT.key===key){SORT.dir=(SORT.dir==="asc")?"desc":"asc"}else{SORT.key=key;SORT.dir="asc"}PAGE=1;update()})})
applyBtn.addEventListener("click",()=>{PAGE=1;update()})
searchInput.addEventListener("keydown",(e)=>{if(e.key==="Enter"){PAGE=1;update()}})
[startDate,endDate].forEach(inp=>{inp.addEventListener("change",()=>{PAGE=1;update()})})
acqSelect.addEventListener("change",()=>{PAGE=1;update()})
advSelect.addEventListener("change",()=>{PAGE=1;update()})
pills.forEach(p=>p.addEventListener("click",()=>setRange(p.dataset.range)))
function countYTD(list){
  const now=new Date();const y=now.getFullYear()
  return list.filter(it=>{const d=parseDate(it.date);return d&&d.getFullYear()===y}).length
}
function countLastDays(list, n){
  const ed=new Date();const sd=new Date();sd.setDate(sd.getDate()-n)
  return list.filter(it=>{const d=parseDate(it.date);return d&&d>=sd&&d<=ed}).length
}
function countTopBanks(list){
  const banks=new Set(["Goldman Sachs","Morgan Stanley","J.P. Morgan"])
  return list.filter(it=>Array.isArray(it.advisors)&&it.advisors.some(a=>banks.has(a))).length
}
function groupByMonthYTD(list){
  const now=new Date();const y=now.getFullYear()
  const m=new Array(12).fill(0)
  list.forEach(it=>{const d=parseDate(it.date);if(d&&d.getFullYear()===y)m[d.getMonth()]+=1})
  return m
}
function topAdvisorCountsYTD(list){
  const now=new Date();const y=now.getFullYear()
  const cnt={}
  list.forEach(it=>{
    const d=parseDate(it.date)
    if(d&&d.getFullYear()===y&&(it.advisors||[]).length){
      it.advisors.forEach(a=>{cnt[a]=(cnt[a]||0)+1})
    }
  })
  const arr=Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,8)
  return {labels:arr.map(x=>x[0]), values:arr.map(x=>x[1])}
}
function updateKPIs(){
  kpiYTD.textContent=countYTD(RAW)
  kpi30.textContent=countLastDays(RAW,30)
  kpiTopBanks.textContent=countTopBanks(RAW)
  kpiUpdate.textContent=new Date().toLocaleTimeString()
}
function updateCharts(){
  const ctxA=document.getElementById("chartAdvisors").getContext("2d")
  const ctxM=document.getElementById("chartMonths").getContext("2d")
  const adv=topAdvisorCountsYTD(RAW)
  const months=groupByMonthYTD(RAW)
  if(chartAdvisors) chartAdvisors.destroy()
  if(chartMonths) chartMonths.destroy()
  chartAdvisors=new Chart(ctxA,{type:"bar",data:{labels:adv.labels,datasets:[{label:"Deals",data:adv.values}]},options:{responsive:true,plugins:{legend:{display:false}}}})
  const labelsM=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]
  chartMonths=new Chart(ctxM,{type:"line",data:{labels:labelsM,datasets:[{label:"Deals",data:months,fill:false}]},options:{responsive:true,plugins:{legend:{display:false}}}})
}
document.getElementById("exportPdf").addEventListener("click",()=>{
  const doc=new jsPDF({unit:"pt",format:"a4"})
  const pad=36
  doc.setFontSize(16);doc.text("M&A Transactions – Advisors & Analytics", pad, 40)
  doc.setFontSize(10);doc.text("Generated: "+new Date().toLocaleString(), pad, 58)
  doc.setFontSize(12)
  const k1="Deals YTD: "+kpiYTD.textContent
  const k2="Last 30 Days: "+kpi30.textContent
  const k3="With GS/MS/JPM: "+kpiTopBanks.textContent
  doc.text(k1, pad, 82);doc.text(k2, pad+180, 82);doc.text(k3, pad+360, 82)
  const c1=document.getElementById("chartAdvisors");const img1=c1.toDataURL("image/png",1.0)
  const c2=document.getElementById("chartMonths");const img2=c2.toDataURL("image/png",1.0)
  doc.addImage(img1,"PNG", pad, 100, 240, 160)
  doc.addImage(img2,"PNG", pad+260, 100, 240, 160)
  const rows=VIEW.slice(0,30).map(it=>[
    it.date||"", it.acquirer||"", it.acquirerTicker||"", it.target||"", it.targetTicker||"", (it.advisors||[]).join("; ")
  ])
  doc.autoTable({startY:280, head:[["Date","Acquirer","Acq Ticker","Target","Tgt Ticker","Advisors"]], body:rows, styles:{fontSize:8}})
  doc.save("ma_report.pdf")
})

async function load(){
  try{
    const res=await fetch(DATA_URL,{cache:"no-cache"})
    const data=await res.json()
    RAW=Array.isArray(data)?data:[]
    buildAcquirerSelect()
    PAGE=1
    update()
  }catch(e){
    tbody.innerHTML=`<tr><td colspan="8" style="text-align:center;color:#c00;">Error loading data</td></tr>`
  }
}
load()
</script>
</body>
</html>
